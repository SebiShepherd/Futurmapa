Index: scripts/app.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>(async () => {\r\n  const state = {\r\n    level: \"world\",\r\n    continent: null,\r\n    country: null,\r\n    selectedPoint: null,\r\n    selectedOrg: ORG_OPTIONS[0]\r\n  };\r\n\r\n  // Runtime configuration loader (tries config.json, falls back to config.example.json)\r\n  async function loadRuntimeConfig() {\r\n    async function tryFetch(path) {\r\n      try {\r\n        const res = await fetch(path, { cache: \"no-store\" });\r\n        if (!res.ok) return null;\r\n        // First try structured JSON parse; if the file contains comments, fall back to stripping them.\r\n        const text = await res.text();\r\n        try {\r\n          return JSON.parse(text);\r\n        } catch (err) {\r\n          // remove // line comments and /* block comments */ and try again\r\n          const stripped = text.replace(/\\/\\/.*$/gm, \"\").replace(/\\/\\*[\\s\\S]*?\\*\\//gm, \"\");\r\n          try {\r\n            return JSON.parse(stripped);\r\n          } catch (err2) {\r\n            return null;\r\n          }\r\n        }\r\n      } catch (e) {\r\n        // ignore\r\n      }\r\n      return null;\r\n    }\r\n\r\n    const fromConfig = await tryFetch(\"config.json\");\r\n    if (fromConfig) {\r\n      fromConfig.__configSource = \"config.json\";\r\n      return fromConfig;\r\n    }\r\n    const fromExample = await tryFetch(\"config.example.json\");\r\n    if (fromExample) {\r\n      fromExample.__configSource = \"config.example.json\";\r\n      return fromExample;\r\n    }\r\n    return { __configSource: \"none\" };\r\n  }\r\n\r\n  function applyRuntimeConfig(cfg) {\r\n    if (!cfg) return;\r\n    try {\r\n      if (cfg.documentTitle) {\r\n        const titleEl = document.getElementById(\"document-title\");\r\n        if (titleEl) titleEl.textContent = cfg.documentTitle;\r\n        document.title = cfg.documentTitle;\r\n      } else if (cfg.companyName) {\r\n        const title = `${cfg.companyName} · Interaktive Konzern-Weltkarte`;\r\n        const titleEl = document.getElementById(\"document-title\");\r\n        if (titleEl) titleEl.textContent = title;\r\n        document.title = title;\r\n      }\r\n\r\n      if (cfg.favicon) {\r\n        // remove existing icon links to avoid conflicts and caching oddities\r\n        document.querySelectorAll('link[rel~=\"icon\"], link[rel~=\"shortcut icon\"]').forEach((n) => n.parentNode && n.parentNode.removeChild(n));\r\n        const head = document.getElementsByTagName('head')[0] || document.documentElement;\r\n        const href = `${cfg.favicon}${cfg.favicon.includes('?') ? '&' : '?'}v=${Date.now()}`;\r\n        // standard icon\r\n        const newLink = document.createElement('link');\r\n        newLink.id = 'favicon-link';\r\n        newLink.rel = 'icon';\r\n        newLink.type = 'image/x-icon';\r\n        newLink.href = href;\r\n        head.appendChild(newLink);\r\n        // legacy shortcut icon for some platforms/browsers\r\n        const newLink2 = document.createElement('link');\r\n        newLink2.rel = 'shortcut icon';\r\n        newLink2.type = 'image/x-icon';\r\n        newLink2.href = href;\r\n        head.appendChild(newLink2);\r\n      }\r\n\r\n      if (cfg.logo) {\r\n        const img = document.getElementById(\"brand-logo\");\r\n        if (img) {\r\n          img.src = cfg.logo;\r\n          img.style.display = \"\";\r\n        }\r\n      }\r\n\r\n      if (cfg.siteTitle) {\r\n        const el = document.getElementById(\"site-title\");\r\n        if (el) el.textContent = cfg.siteTitle;\r\n      }\r\n\r\n      if (cfg.subtitle) {\r\n        const el = document.getElementById(\"site-subtitle\");\r\n        if (el) el.textContent = cfg.subtitle;\r\n      }\r\n    } catch (e) {\r\n      console.warn(\"Applying runtime config failed\", e);\r\n    }\r\n  }\r\n\r\n  const RUNTIME_CONFIG = await loadRuntimeConfig();\r\n  console.info(\"Loaded runtime config from:\", RUNTIME_CONFIG.__configSource || \"unknown\", RUNTIME_CONFIG);\r\n  applyRuntimeConfig(RUNTIME_CONFIG);\r\n\r\n  const mapContainer = document.getElementById(\"map\");\r\n  const detailPanel = document.getElementById(\"detail-panel\");\r\n  const panelTitle = document.getElementById(\"panel-title\");\r\n  const panelSubtitle = document.getElementById(\"panel-subtitle\");\r\n  const panelBody = document.getElementById(\"panel-body\");\r\n  const orgSelector = document.getElementById(\"org-selector\");\r\n  const resetButton = document.getElementById(\"reset-view\");\r\n  const tooltip = document.getElementById(\"map-tooltip\");\r\n  const continentSummary = document.getElementById(\"continent-summary\");\r\n  const countryList = document.getElementById(\"country-list\");\r\n  const breadcrumb = document.getElementById(\"breadcrumb\");\r\n  const chipsContainer = document.getElementById(\"continent-chips\");\r\n\r\n  const svg = d3.select(mapContainer).append(\"svg\");\r\n  const defs = svg.append(\"defs\");\r\n  const dropShadowFilter = defs\r\n    .append(\"filter\")\r\n    .attr(\"id\", \"map-drop-shadow\")\r\n    .attr(\"x\", \"-35%\")\r\n    .attr(\"y\", \"-35%\")\r\n    .attr(\"width\", \"170%\")\r\n    .attr(\"height\", \"170%\")\r\n    .attr(\"color-interpolation-filters\", \"sRGB\");\r\n\r\n  dropShadowFilter\r\n    .append(\"feGaussianBlur\")\r\n    .attr(\"in\", \"SourceAlpha\")\r\n    .attr(\"stdDeviation\", 6)\r\n    .attr(\"result\", \"shadow\");\r\n\r\n  dropShadowFilter\r\n    .append(\"feOffset\")\r\n    .attr(\"in\", \"shadow\")\r\n    .attr(\"dx\", 0)\r\n    .attr(\"dy\", 0)\r\n    .attr(\"result\", \"offset-shadow\");\r\n\r\n  const rootStyles = getComputedStyle(document.documentElement);\r\n  \r\n  // Read glow color from CSS variable, fallback to white\r\n  const glowColor = rootStyles.getPropertyValue('--map-glow-strong')?.trim() || '#ffffff';\r\n  dropShadowFilter\r\n    .append(\"feFlood\")\r\n    .attr(\"flood-color\", glowColor)\r\n    .attr(\"flood-opacity\", 0.85)\r\n    .attr(\"result\", \"shadow-color\");\r\n\r\n  dropShadowFilter\r\n    .append(\"feComposite\")\r\n    .attr(\"in\", \"shadow-color\")\r\n    .attr(\"in2\", \"offset-shadow\")\r\n    .attr(\"operator\", \"in\")\r\n    .attr(\"result\", \"glow\");\r\n\r\n  const dropShadowMerge = dropShadowFilter.append(\"feMerge\");\r\n  dropShadowMerge.append(\"feMergeNode\").attr(\"in\", \"glow\");\r\n  dropShadowMerge.append(\"feMergeNode\").attr(\"in\", \"SourceGraphic\");\r\n  const backgroundGlowStrong =\r\n    rootStyles.getPropertyValue(\"--map-background-glow-strong\")?.trim() || \"rgba(255, 255, 255, 0.35)\";\r\n  const backgroundGlowSoft =\r\n    rootStyles.getPropertyValue(\"--map-background-glow-soft\")?.trim() || \"rgba(255, 255, 255, 0.12)\";\r\n\r\n  const backgroundGradient = defs\r\n    .append(\"radialGradient\")\r\n    .attr(\"id\", \"map-background-gradient\")\r\n    .attr(\"cx\", \"50%\")\r\n    .attr(\"cy\", \"45%\")\r\n    .attr(\"r\", \"65%\");\r\n  backgroundGradient.append(\"stop\").attr(\"offset\", \"0%\").attr(\"stop-color\", backgroundGlowStrong);\r\n  backgroundGradient.append(\"stop\").attr(\"offset\", \"60%\").attr(\"stop-color\", backgroundGlowSoft);\r\n  backgroundGradient.append(\"stop\").attr(\"offset\", \"100%\").attr(\"stop-color\", \"rgba(255, 255, 255, 0)\");\r\n\r\n  const clipPath = defs.append(\"clipPath\").attr(\"id\", \"map-clip\");\r\n  const clipPathRect = clipPath.append(\"rect\");\r\n\r\n  const projection = d3.geoNaturalEarth1();\r\n  const geoPath = d3.geoPath(projection);\r\n\r\n  const backgroundRect = svg\r\n    .append(\"rect\")\r\n    .attr(\"class\", \"map-background\")\r\n    .attr(\"fill\", \"url(#map-background-gradient)\");\r\n\r\n  const mapLayer = svg.append(\"g\").attr(\"class\", \"map-layer\").attr(\"clip-path\", \"url(#map-clip)\");\r\n  const countriesLayer = mapLayer.append(\"g\").attr(\"class\", \"countries-layer\");\r\n\r\n  const pointsLayer = svg.append(\"g\").attr(\"class\", \"points-layer\").attr(\"clip-path\", \"url(#map-clip)\");\r\n\r\n  const zoom = d3\r\n    .zoom()\r\n    .scaleExtent([1, 10])\r\n    .on(\"zoom\", handleZoom);\r\n\r\n  svg.call(zoom);\r\n  svg.on(\"dblclick.zoom\", null);\r\n  svg.on(\"dblclick\", () => {\r\n    resetView();\r\n  });\r\n\r\n  let currentTransform = d3.zoomIdentity;\r\n  let width = mapContainer.clientWidth || 800;\r\n  let height = mapContainer.clientHeight || 600;\r\n\r\n  function normalizeFeatureOrientation(feature) {\r\n    if (!feature?.geometry) {\r\n      return feature;\r\n    }\r\n\r\n    const area = d3.geoArea(feature);\r\n    if (!Number.isFinite(area) || area <= 2 * Math.PI) {\r\n      return feature;\r\n    }\r\n\r\n    const flipRing = (ring) => (Array.isArray(ring) ? ring.slice().reverse() : ring);\r\n    const geometry = feature.geometry;\r\n\r\n    if (geometry.type === \"Polygon\") {\r\n      geometry.coordinates = geometry.coordinates.map(flipRing);\r\n    } else if (geometry.type === \"MultiPolygon\") {\r\n      geometry.coordinates = geometry.coordinates.map((polygon) => polygon.map(flipRing));\r\n    }\r\n\r\n    return feature;\r\n  }\r\n\r\n  const worldFeatures = WORLD_GEOJSON.features\r\n    .filter((feature) => feature.id !== \"ATA\")\r\n    .map(normalizeFeatureOrientation);\r\n  const worldView = { type: \"FeatureCollection\", features: worldFeatures };\r\n  const featureByIso = new Map(worldFeatures.map((feature) => [feature.id, feature]));\r\n\r\n  function isCountryActive(iso) {\r\n    const config = COUNTRY_BY_ISO.get(iso);\r\n    return !!(config && config.active);\r\n  }\r\n\r\n  function updateProjection() {\r\n    width = mapContainer.clientWidth || mapContainer.offsetWidth || 800;\r\n    height = mapContainer.clientHeight || mapContainer.offsetHeight || 600;\r\n    svg.attr(\"width\", width).attr(\"height\", height);\r\n\r\n    projection.fitExtent(\r\n      [\r\n        [40, 40],\r\n        [width - 40, height - 40]\r\n      ],\r\n      worldView\r\n    );\r\n\r\n    backgroundRect.attr(\"width\", width).attr(\"height\", height).attr(\"x\", 0).attr(\"y\", 0);\r\n    clipPathRect.attr(\"width\", width).attr(\"height\", height).attr(\"x\", 0).attr(\"y\", 0);\r\n\r\n    const bounds = geoPath.bounds(worldView);\r\n    if (bounds && bounds.length === 2) {\r\n      const padding = 20;\r\n      const [[x0, y0], [x1, y1]] = bounds;\r\n      if ([x0, y0, x1, y1].every((value) => Number.isFinite(value))) {\r\n        zoom\r\n          .extent([\r\n            [0, 0],\r\n            [width, height]\r\n          ])\r\n          .translateExtent([\r\n            [x0 - padding, y0 - padding],\r\n            [x1 + padding, y1 + padding]\r\n          ]);\r\n      }\r\n    }\r\n\r\n    countriesLayer.selectAll(\"path\").attr(\"d\", geoPath);\r\n    updatePointPositions();\r\n    svg.call(zoom.transform, currentTransform);\r\n  }\r\n\r\n  function drawCountries() {\r\n    const countrySelection = countriesLayer.selectAll(\"path\").data(worldFeatures, (d) => d.id);\r\n\r\n    const entered = countrySelection\r\n      .enter()\r\n      .append(\"path\")\r\n      .attr(\"class\", \"country\")\r\n      .attr(\"d\", geoPath)\r\n      .on(\"mousemove\", handleMouseMove)\r\n      .on(\"mouseleave\", handleMouseLeave)\r\n      .on(\"click\", handleCountryClick);\r\n\r\n    countrySelection.exit().remove();\r\n\r\n    countrySelection.merge(entered).attr(\"d\", geoPath);\r\n    updateCountryClasses();\r\n    updateStrokeWidths();\r\n  }\r\n\r\n  function handleMouseMove(event, feature) {\r\n    const iso = feature.id;\r\n    const countryConfig = COUNTRY_BY_ISO.get(iso);\r\n    const [x, y] = d3.pointer(event, mapContainer);\r\n\r\n    tooltip.style.left = `${x}px`;\r\n    tooltip.style.top = `${y}px`;\r\n    if (countryConfig) {\r\n      tooltip.textContent = `${countryConfig.name}${countryConfig.active ? \" · aktiv\" : \" · in Vorbereitung\"}`;\r\n    } else {\r\n      tooltip.textContent = feature.properties?.name || iso;\r\n    }\r\n    tooltip.classList.add(\"is-visible\");\r\n  }\r\n\r\n  function handleMouseLeave() {\r\n    tooltip.classList.remove(\"is-visible\");\r\n  }\r\n\r\n  function handleCountryClick(event, feature) {\r\n    event.stopPropagation();\r\n    const iso = feature.id;\r\n    const config = COUNTRY_BY_ISO.get(iso);\r\n    if (!config || !config.active) {\r\n      return;\r\n    }\r\n\r\n    if (state.level === \"world\") {\r\n      focusContinent(config.continent, { highlightCountry: iso });\r\n    } else {\r\n      focusCountry(iso);\r\n    }\r\n  }\r\n\r\n  function handleZoom(event) {\r\n    currentTransform = event.transform;\r\n    mapLayer.attr(\"transform\", currentTransform);\r\n    updatePointTransforms();\r\n    updateStrokeWidths();\r\n  }\r\n\r\n  function updateStrokeWidths() {\r\n    const scaleFactor = Math.sqrt(currentTransform.k || 1);\r\n    countriesLayer.selectAll(\"path\").style(\"stroke-width\", 0.6 / scaleFactor);\r\n  }\r\n\r\n  function updateCountryClasses() {\r\n    countriesLayer.selectAll(\"path\").each(function (feature) {\r\n      const iso = feature.id;\r\n      const selection = d3.select(this);\r\n      const config = COUNTRY_BY_ISO.get(iso);\r\n      const isActive = !!(config && config.active);\r\n      const highlight = state.country\r\n        ? iso === state.country\r\n        : state.continent\r\n        ? isActive && config && config.continent === state.continent\r\n        : false;\r\n\r\n      selection.classed(\"is-active\", isActive);\r\n      selection.classed(\"is-inactive\", !isActive);\r\n      selection.classed(\"is-highlighted\", highlight);\r\n    });\r\n  }\r\n\r\n  function focusContinent(continentName, options = {}) {\r\n    const continent = DATA_CONFIG.continents[continentName];\r\n    if (!continent) return;\r\n\r\n    state.level = \"continent\";\r\n    state.continent = continentName;\r\n    state.country = null;\r\n    state.selectedPoint = null;\r\n\r\n    hideDetailPanel();\r\n    updateBreadcrumb();\r\n    renderContinentSummary();\r\n    renderCountryList(options.highlightCountry);\r\n    updateContinentChips();\r\n    updateCountryClasses();\r\n    updatePoints(null);\r\n\r\n    const features = continent.countries\r\n      .map((iso) => featureByIso.get(iso))\r\n      .filter(Boolean);\r\n\r\n    const shouldAnimate = options.animate !== false;\r\n\r\n    if (features.length) {\r\n      zoomToCollection({ type: \"FeatureCollection\", features }, shouldAnimate);\r\n    } else {\r\n      zoomToWorld(shouldAnimate);\r\n    }\r\n  }\r\n\r\n  function focusCountry(iso, options = {}) {\r\n    const config = COUNTRY_BY_ISO.get(iso);\r\n    if (!config || !config.active) return;\r\n\r\n    state.level = \"country\";\r\n    state.continent = config.continent;\r\n    state.country = iso;\r\n    state.selectedPoint = null;\r\n    state.selectedOrg = ORG_OPTIONS[0];\r\n\r\n    hideDetailPanel();\r\n    updateBreadcrumb();\r\n    renderContinentSummary();\r\n    renderCountryList();\r\n    updateContinentChips();\r\n    updateCountryClasses();\r\n\r\n    updatePoints(iso);\r\n\r\n    const feature = featureByIso.get(iso);\r\n    if (feature) {\r\n      zoomToCollection({ type: \"FeatureCollection\", features: [feature] }, options.animate !== false);\r\n    }\r\n  }\r\n\r\n  function zoomToWorld(animate = true) {\r\n    if (animate) {\r\n      svg.transition().duration(900).call(zoom.transform, d3.zoomIdentity);\r\n    } else {\r\n      svg.call(zoom.transform, d3.zoomIdentity);\r\n    }\r\n  }\r\n\r\n  function zoomToCollection(collection, animate = true) {\r\n    const bounds = geoPath.bounds(collection);\r\n    const dx = bounds[1][0] - bounds[0][0];\r\n    const dy = bounds[1][1] - bounds[0][1];\r\n    const x = (bounds[0][0] + bounds[1][0]) / 2;\r\n    const y = (bounds[0][1] + bounds[1][1]) / 2;\r\n\r\n    if (!dx || !dy) {\r\n      zoomToWorld(animate);\r\n      return;\r\n    }\r\n\r\n    const [minScale, maxScale] = zoom.scaleExtent();\r\n    const targetScale = Math.min(8, 0.9 / Math.max(dx / width, dy / height));\r\n    const scale = Math.max(minScale, Math.min(maxScale, targetScale));\r\n    const translate = [width / 2 - scale * x, height / 2 - scale * y];\r\n    const transform = d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale);\r\n\r\n    if (animate) {\r\n      svg.transition().duration(900).call(zoom.transform, transform);\r\n    } else {\r\n      svg.call(zoom.transform, transform);\r\n    }\r\n  }\r\n\r\n  function updatePoints(countryIso) {\r\n    const dataPoints = countryIso ? COUNTRY_BY_ISO.get(countryIso)?.points || [] : [];\r\n\r\n    const selection = pointsLayer.selectAll(\".data-point\").data(dataPoints, (d) => d.id);\r\n\r\n    selection\r\n      .exit()\r\n      .transition()\r\n      .duration(300)\r\n      .style(\"opacity\", 0)\r\n      .remove();\r\n\r\n    const entered = selection\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"class\", \"data-point\")\r\n      .style(\"opacity\", 0)\r\n      .on(\"click\", function (event, d) {\r\n        event.stopPropagation();\r\n        const countryConfig = COUNTRY_BY_ISO.get(countryIso);\r\n        openDetailPanel(d, countryConfig);\r\n      });\r\n\r\n    entered.append(\"circle\").attr(\"class\", \"point-ring\").attr(\"r\", 32);\r\n    entered.append(\"circle\").attr(\"class\", \"point-core\").attr(\"r\", 20);\r\n    \r\n    // Add SVG icon instead of text\r\n    // SVG icons are 24x24, centered at origin with scale ~0.83 to fit in 20px core circle\r\n    const ICON_SIZE = 24;\r\n    const ICON_OFFSET = -ICON_SIZE / 2; \r\n    const ICON_SCALE = 0.83;\r\n    \r\n    const iconGroup = entered.append(\"g\").attr(\"class\", \"point-icon\");\r\n    iconGroup\r\n      .append(\"path\")\r\n      .attr(\"d\", (d) => SVG_ICONS[DATA_CONFIG.categories[d.category]?.icon] || \"\")\r\n      .attr(\"transform\", `translate(${ICON_OFFSET}, ${ICON_OFFSET}) scale(${ICON_SCALE})`)\r\n      .attr(\"fill\", \"#0b162f\");\r\n    \r\n    entered.append(\"title\").text((d) => d.title);\r\n\r\n    const merged = entered.merge(selection);\r\n\r\n    merged.each(function (d) {\r\n      d.countryIso = countryIso;\r\n      if (!Array.isArray(d.coordinates) || d.coordinates.length !== 2) return;\r\n      d.projected = projection(d.coordinates);\r\n      const [px, py] = currentTransform.apply(d.projected);\r\n      const category = DATA_CONFIG.categories[d.category];\r\n      const color = category?.color || \"#ffffff\";\r\n      d3.select(this)\r\n        .classed(\"coming-soon\", !!d.comingSoon)\r\n        .attr(\"transform\", `translate(${px},${py})`)\r\n        .style(\"opacity\", 1)\r\n        .select(\"circle.point-core\")\r\n        .attr(\"fill\", color);\r\n    });\r\n\r\n    highlightSelectedPoint(null);\r\n  }\r\n\r\n  function updatePointPositions() {\r\n    pointsLayer.selectAll(\".data-point\").each(function (d) {\r\n      if (!Array.isArray(d.coordinates)) return;\r\n      d.projected = projection(d.coordinates);\r\n    });\r\n  }\r\n\r\n  function updatePointTransforms() {\r\n    pointsLayer.selectAll(\".data-point\").each(function (d) {\r\n      if (!d.projected) return;\r\n      const [x, y] = currentTransform.apply(d.projected);\r\n      d3.select(this).attr(\"transform\", `translate(${x},${y})`);\r\n    });\r\n  }\r\n\r\n  function renderContinentSummary() {\r\n    continentSummary.innerHTML = \"\";\r\n\r\n    if (state.country) {\r\n      const countryConfig = COUNTRY_BY_ISO.get(state.country);\r\n      if (!countryConfig) return;\r\n      const title = document.createElement(\"h2\");\r\n      title.textContent = countryConfig.name;\r\n      const paragraph = document.createElement(\"p\");\r\n      paragraph.textContent = countryConfig.overview || \"Keine Übersicht verfügbar.\";\r\n      continentSummary.appendChild(title);\r\n      continentSummary.appendChild(paragraph);\r\n    } else if (state.continent) {\r\n      const info = DATA_CONFIG.continents[state.continent];\r\n      const title = document.createElement(\"h2\");\r\n      title.textContent = state.continent;\r\n      const paragraph = document.createElement(\"p\");\r\n      paragraph.textContent = info?.description || \"Keine Beschreibung verfügbar.\";\r\n      continentSummary.appendChild(title);\r\n      continentSummary.appendChild(paragraph);\r\n    } else {\r\n      const title = document.createElement(\"h2\");\r\n      title.textContent = \"So funktioniert es\";\r\n      const paragraph = document.createElement(\"p\");\r\n      paragraph.innerHTML =\r\n        \"<strong>1.</strong> Kontinent auswählen · <strong>2.</strong> Land fokussieren · <strong>3.</strong> Themenpunkt öffnen.\";\r\n      const info = document.createElement(\"p\");\r\n      info.textContent = \"Alle Kennzahlen lassen sich direkt ohne Backend anpassen (siehe scripts/data.js).\";\r\n      continentSummary.appendChild(title);\r\n      continentSummary.appendChild(paragraph);\r\n      continentSummary.appendChild(info);\r\n    }\r\n  }\r\n\r\n  function renderCountryList(highlightCountry) {\r\n    countryList.innerHTML = \"\";\r\n\r\n    if (!state.continent) {\r\n      const title = document.createElement(\"h2\");\r\n      title.textContent = \"Kontinente\";\r\n      const text = document.createElement(\"p\");\r\n      text.textContent = \"Nutze die Chips oder klicke auf die Karte, um zu einer Region zu springen.\";\r\n      countryList.appendChild(title);\r\n      countryList.appendChild(text);\r\n      return;\r\n    }\r\n\r\n     const continent = DATA_CONFIG.continents[state.continent];\r\n    const title = document.createElement(\"h2\");\r\n    title.textContent = `${state.continent} · Länder`;\r\n    countryList.appendChild(title);\r\n\r\n    const list = document.createElement(\"div\");\r\n    list.className = \"country-buttons\";\r\n\r\n    continent.countries.forEach((iso) => {\r\n      const config = COUNTRY_BY_ISO.get(iso);\r\n      const button = document.createElement(\"button\");\r\n      button.className = \"country-button\";\r\n      button.type = \"button\";\r\n\r\n      const name = config?.name || featureByIso.get(iso)?.properties?.name || iso;\r\n      const label = document.createElement(\"span\");\r\n      label.textContent = name;\r\n      const status = document.createElement(\"small\");\r\n      if (config?.active) {\r\n        status.textContent = \"Aktiv\";\r\n      } else {\r\n        status.textContent = \"In Vorbereitung\";\r\n      }\r\n\r\n      button.appendChild(label);\r\n      button.appendChild(status);\r\n\r\n      if (!config || !config.active) {\r\n        button.classList.add(\"is-disabled\");\r\n        button.disabled = true;\r\n      } else {\r\n        button.addEventListener(\"click\", () => {\r\n          focusCountry(iso);\r\n        });\r\n      }\r\n\r\n      if (state.country === iso) {\r\n        button.classList.add(\"is-active\");\r\n      } else if (highlightCountry && highlightCountry === iso) {\r\n        button.classList.add(\"is-active\");\r\n      }\r\n\r\n      list.appendChild(button);\r\n    });\r\n\r\n    countryList.appendChild(list);\r\n  }\r\n\r\n  function renderLegend() {\r\n    const legend = document.getElementById(\"legend\");\r\n    legend.innerHTML = \"\";\r\n\r\n    const title = document.createElement(\"h2\");\r\n    title.textContent = \"Legende\";\r\n    legend.appendChild(title);\r\n\r\n    Object.values(DATA_CONFIG.categories).forEach((value) => {\r\n      const item = document.createElement(\"div\");\r\n      item.className = \"legend-item\";\r\n      const swatch = document.createElement(\"span\");\r\n      swatch.className = \"swatch\";\r\n      swatch.style.background = value.color;\r\n      const textWrapper = document.createElement(\"div\");\r\n      const label = document.createElement(\"strong\");\r\n      label.textContent = value.label;\r\n      const description = document.createElement(\"div\");\r\n      description.textContent = value.description;\r\n      textWrapper.appendChild(label);\r\n      textWrapper.appendChild(description);\r\n      item.appendChild(swatch);\r\n      item.appendChild(textWrapper);\r\n      legend.appendChild(item);\r\n    });\r\n  }\r\n\r\n  function renderContinentChips() {\r\n    chipsContainer.innerHTML = \"\";\r\n\r\n    CONTINENT_LIST.forEach((name) => {\r\n      const chip = document.createElement(\"button\");\r\n      chip.type = \"button\";\r\n      chip.className = \"chip\";\r\n    const activeCount = DATA_CONFIG.continents[name].countries.filter((iso) => isCountryActive(iso)).length;\r\n    chip.innerHTML = `<span>${name}</span><small>${activeCount} Standorte</small>`;\r\n    chip.addEventListener(\"click\", () => {\r\n      focusContinent(name);\r\n    });\r\n    chipsContainer.appendChild(chip);\r\n  });\r\n\r\n    updateContinentChips();\r\n  }\r\n\r\n  function updateContinentChips() {\r\n    const chipNodes = chipsContainer.querySelectorAll(\".chip\");\r\n    chipNodes.forEach((chip) => {\r\n      const label = chip.querySelector(\"span\")?.textContent || \"\";\r\n      chip.classList.toggle(\"is-active\", !!state.continent && label === state.continent);\r\n    });\r\n  }\r\n\r\n  function updateBreadcrumb() {\r\n    breadcrumb.innerHTML = \"\";\r\n\r\n    const items = [];\r\n    items.push({ label: \"Welt\", action: () => resetView(), clickable: state.level !== \"world\" });\r\n    if (state.continent) {\r\n      items.push({\r\n        label: state.continent,\r\n        action: () => focusContinent(state.continent),\r\n        clickable: state.level === \"country\"\r\n      });\r\n    }\r\n    if (state.country) {\r\n      const countryName = COUNTRY_BY_ISO.get(state.country)?.name || state.country;\r\n      items.push({ label: countryName, clickable: false });\r\n    }\r\n\r\n    items.forEach((item, index) => {\r\n      if (index > 0) {\r\n        const separator = document.createElement(\"span\");\r\n        separator.textContent = \"›\";\r\n        separator.className = \"breadcrumb-separator\";\r\n        breadcrumb.appendChild(separator);\r\n      }\r\n\r\n      const wrapper = document.createElement(\"span\");\r\n      wrapper.className = \"breadcrumb-item\";\r\n\r\n      if (item.clickable) {\r\n        const button = document.createElement(\"button\");\r\n        button.type = \"button\";\r\n        button.textContent = item.label;\r\n        button.addEventListener(\"click\", item.action);\r\n        wrapper.appendChild(button);\r\n      } else {\r\n        const label = document.createElement(\"span\");\r\n        label.textContent = item.label;\r\n        wrapper.appendChild(label);\r\n      }\r\n\r\n      breadcrumb.appendChild(wrapper);\r\n    });\r\n  }\r\n\r\n  function highlightSelectedPoint(pointId) {\r\n    pointsLayer.selectAll(\".data-point\").classed(\"is-selected\", (d) => d.id === pointId);\r\n    state.selectedPoint = pointId;\r\n  }\r\n\r\n  function renderOrgSelector(point) {\r\n    orgSelector.innerHTML = \"\";\r\n\r\n    if (point?.comingSoon) {\r\n      orgSelector.style.display = \"none\";\r\n      return;\r\n    }\r\n\r\n    orgSelector.style.display = \"flex\";\r\n\r\n    ORG_OPTIONS.forEach((option) => {\r\n      const button = document.createElement(\"button\");\r\n      button.type = \"button\";\r\n      button.className = \"org-option\";\r\n      button.textContent = option;\r\n      button.setAttribute(\"role\", \"radio\");\r\n      button.setAttribute(\"aria-checked\", option === state.selectedOrg ? \"true\" : \"false\");\r\n      button.addEventListener(\"click\", () => {\r\n        state.selectedOrg = option;\r\n        updateOrgSelector(point);\r\n        updatePanelContent(point);\r\n      });\r\n      if (option === state.selectedOrg) {\r\n        button.classList.add(\"is-active\");\r\n      }\r\n      orgSelector.appendChild(button);\r\n    });\r\n  }\r\n\r\n  function updateOrgSelector(point) {\r\n    orgSelector.querySelectorAll(\".org-option\").forEach((button) => {\r\n      const isActive = button.textContent === state.selectedOrg;\r\n      button.setAttribute(\"aria-checked\", isActive ? \"true\" : \"false\");\r\n      button.classList.toggle(\"is-active\", isActive);\r\n      button.disabled = !!point?.comingSoon;\r\n    });\r\n  }\r\n\r\n  function createMetricCard(metric) {\r\n    const card = document.createElement(\"div\");\r\n    card.className = \"metric-card\";\r\n    const title = document.createElement(\"h3\");\r\n    title.textContent = metric.label;\r\n    const value = document.createElement(\"div\");\r\n    value.className = \"metric-value\";\r\n    value.textContent = metric.value;\r\n    card.appendChild(title);\r\n    card.appendChild(value);\r\n    if (metric.trend) {\r\n      const trend = document.createElement(\"div\");\r\n      trend.className = \"metric-trend\";\r\n      trend.textContent = metric.trend;\r\n      if (/^\\+/.test(metric.trend)) {\r\n        trend.classList.add(\"is-positive\");\r\n      } else if (/^−|-/.test(metric.trend)) {\r\n        trend.classList.add(\"is-negative\");\r\n      }\r\n      card.appendChild(trend);\r\n    }\r\n    return card;\r\n  }\r\n\r\n  function renderProgressList(items) {\r\n    const wrapper = document.createElement(\"div\");\r\n    wrapper.className = \"progress-list\";\r\n    items.forEach((item) => {\r\n      const block = document.createElement(\"div\");\r\n      block.className = \"progress-item\";\r\n      const label = document.createElement(\"span\");\r\n      label.textContent = item.label;\r\n      const bar = document.createElement(\"div\");\r\n      bar.className = \"progress-bar\";\r\n      const fill = document.createElement(\"div\");\r\n      fill.className = \"fill\";\r\n      const value = Math.max(0, Math.min(100, item.value ?? 0));\r\n      fill.style.width = `${value}%`;\r\n      bar.appendChild(fill);\r\n      block.appendChild(label);\r\n      block.appendChild(bar);\r\n      wrapper.appendChild(block);\r\n    });\r\n    return wrapper;\r\n  }\r\n\r\n  function renderCompareGrid(dataset) {\r\n    const grid = document.createElement(\"div\");\r\n    grid.className = \"compare-grid\";\r\n\r\n    const left = document.createElement(\"div\");\r\n    left.className = \"compare-column\";\r\n    const leftTitle = document.createElement(\"h3\");\r\n    leftTitle.textContent = dataset.leftLabel || \"CVS\";\r\n    left.appendChild(leftTitle);\r\n    const leftList = document.createElement(\"ul\");\r\n\r\n    const right = document.createElement(\"div\");\r\n    right.className = \"compare-column\";\r\n    const rightTitle = document.createElement(\"h3\");\r\n    rightTitle.textContent = dataset.rightLabel || \"RVS\";\r\n    right.appendChild(rightTitle);\r\n    const rightList = document.createElement(\"ul\");\r\n\r\n    (dataset.metrics || []).forEach((metric) => {\r\n      const leftItem = document.createElement(\"li\");\r\n      const leftLabel = document.createElement(\"span\");\r\n      leftLabel.textContent = metric.label;\r\n      const leftValue = document.createElement(\"span\");\r\n      leftValue.className = \"value\";\r\n      leftValue.textContent = metric.left ?? \"—\";\r\n      leftItem.appendChild(leftLabel);\r\n      leftItem.appendChild(leftValue);\r\n      leftList.appendChild(leftItem);\r\n\r\n      const rightItem = document.createElement(\"li\");\r\n      const rightLabel = document.createElement(\"span\");\r\n      rightLabel.textContent = metric.label;\r\n      const rightValue = document.createElement(\"span\");\r\n      rightValue.className = \"value\";\r\n      rightValue.textContent = metric.right ?? \"—\";\r\n      rightItem.appendChild(rightLabel);\r\n      rightItem.appendChild(rightValue);\r\n      rightList.appendChild(rightItem);\r\n    });\r\n\r\n    left.appendChild(leftList);\r\n    right.appendChild(rightList);\r\n    grid.appendChild(left);\r\n    grid.appendChild(right);\r\n    return grid;\r\n  }\r\n\r\n  function updatePanelContent(point) {\r\n    panelBody.innerHTML = \"\";\r\n\r\n    if (!point) return;\r\n\r\n    if (point.comingSoon) {\r\n      const info = document.createElement(\"div\");\r\n      info.className = \"coming-soon\";\r\n      info.textContent = \"Coming Soon: Datensatz befindet sich in Vorbereitung.\";\r\n      panelBody.appendChild(info);\r\n      return;\r\n    }\r\n\r\n    let dataset;\r\n    if (state.selectedOrg === \"CVS vs RVS\") {\r\n      dataset = point.data?.compare;\r\n    } else {\r\n      dataset = point.data?.[state.selectedOrg];\r\n    }\r\n\r\n    if (!dataset) {\r\n      const message = document.createElement(\"div\");\r\n      message.className = \"no-data\";\r\n      message.textContent = \"Kein Datensatz verfügbar.\";\r\n      panelBody.appendChild(message);\r\n      return;\r\n    }\r\n\r\n    if (dataset.summary) {\r\n      const summary = document.createElement(\"div\");\r\n      summary.className = \"dataset-summary\";\r\n      summary.textContent = dataset.summary;\r\n      panelBody.appendChild(summary);\r\n    }\r\n\r\n    if (state.selectedOrg === \"CVS vs RVS\") {\r\n      panelBody.appendChild(renderCompareGrid(dataset));\r\n    } else {\r\n      if (dataset.metrics?.length) {\r\n        const grid = document.createElement(\"div\");\r\n        grid.className = \"metric-grid\";\r\n        dataset.metrics.forEach((metric) => {\r\n          grid.appendChild(createMetricCard(metric));\r\n        });\r\n        panelBody.appendChild(grid);\r\n      }\r\n\r\n      if (dataset.progress?.length) {\r\n        panelBody.appendChild(renderProgressList(dataset.progress));\r\n      }\r\n    }\r\n  }\r\n\r\n  function openDetailPanel(point, countryConfig) {\r\n    highlightSelectedPoint(point.id);\r\n    state.selectedOrg = ORG_OPTIONS[0];\r\n\r\n    panelTitle.textContent = point.title;\r\n    const category = DATA_CONFIG.categories[point.category];\r\n    panelSubtitle.textContent = `${countryConfig?.name || \"\"} · ${category?.label || \"\"}`;\r\n\r\n    renderOrgSelector(point);\r\n    updatePanelContent(point);\r\n\r\n    detailPanel.classList.add(\"is-visible\");\r\n    detailPanel.setAttribute(\"aria-hidden\", \"false\");\r\n  }\r\n\r\n  function hideDetailPanel() {\r\n    detailPanel.classList.remove(\"is-visible\");\r\n    detailPanel.setAttribute(\"aria-hidden\", \"true\");\r\n    highlightSelectedPoint(null);\r\n  }\r\n\r\n  function resetView() {\r\n    state.level = \"world\";\r\n    state.continent = null;\r\n    state.country = null;\r\n    state.selectedPoint = null;\r\n    state.selectedOrg = ORG_OPTIONS[0];\r\n    hideDetailPanel();\r\n    updateBreadcrumb();\r\n    renderContinentSummary();\r\n    renderCountryList();\r\n    updateContinentChips();\r\n    updateCountryClasses();\r\n    updatePoints(null);\r\n    zoomToWorld(true);\r\n  }\r\n\r\n  function restoreCurrentView() {\r\n    if (state.level === \"country\" && state.country) {\r\n      focusCountry(state.country, { animate: false });\r\n    } else if (state.level === \"continent\" && state.continent) {\r\n      focusContinent(state.continent, { highlightCountry: state.country, animate: false });\r\n    } else {\r\n      zoomToWorld(false);\r\n    }\r\n  }\r\n\r\n  function handleResize() {\r\n    updateProjection();\r\n    drawCountries();\r\n    updatePointPositions();\r\n    updatePointTransforms();\r\n    restoreCurrentView();\r\n  }\r\n\r\n  document.querySelector(\".close-detail\").addEventListener(\"click\", hideDetailPanel);\r\n  detailPanel.addEventListener(\"click\", (event) => {\r\n    if (event.target === detailPanel) {\r\n      hideDetailPanel();\r\n    }\r\n  });\r\n  document.addEventListener(\"keydown\", (event) => {\r\n    if (event.key === \"Escape\") {\r\n      hideDetailPanel();\r\n    }\r\n  });\r\n\r\n  resetButton.addEventListener(\"click\", () => resetView());\r\n\r\n  renderLegend();\r\n  renderContinentChips();\r\n  updateProjection();\r\n  drawCountries();\r\n  renderContinentSummary();\r\n  renderCountryList();\r\n  updateBreadcrumb();\r\n  updateCountryClasses();\r\n  zoomToWorld(false);\r\n\r\n  window.addEventListener(\"resize\", handleResize);\r\n})();\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/scripts/app.js b/scripts/app.js
--- a/scripts/app.js	(revision 39111da0c5cef90353b52e334b697e8d8f08bdfe)
+++ b/scripts/app.js	(date 1760863703103)
@@ -144,13 +144,10 @@
 
   const rootStyles = getComputedStyle(document.documentElement);
   
-  // Read glow color from CSS variable, fallback to white
-  const glowColor = rootStyles.getPropertyValue('--map-glow-strong')?.trim() || '#ffffff';
-  dropShadowFilter
-    .append("feFlood")
-    .attr("flood-color", glowColor)
-    .attr("flood-opacity", 0.85)
-    .attr("result", "shadow-color");
+  // Suggestion: Read glow color from CSS variable, fallback to white
+    dropShadowFilter
+        .append("feFlood")
+        .attr("flood-color", "#ffffff")
 
   dropShadowFilter
     .append("feComposite")
@@ -479,9 +476,9 @@
     // Add SVG icon instead of text
     // SVG icons are 24x24, centered at origin with scale ~0.83 to fit in 20px core circle
     const ICON_SIZE = 24;
-    const ICON_OFFSET = -ICON_SIZE / 2; 
-    const ICON_SCALE = 0.83;
-    
+    const ICON_OFFSET = -ICON_SIZE / 2;
+    const ICON_SCALE = 1;
+
     const iconGroup = entered.append("g").attr("class", "point-icon");
     iconGroup
       .append("path")
